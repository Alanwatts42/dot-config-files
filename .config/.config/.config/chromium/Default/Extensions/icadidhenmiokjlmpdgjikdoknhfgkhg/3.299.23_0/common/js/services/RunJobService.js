"use strict";angular.module("MetronicApp").factory("RunJobService",["$window","$q","DataService","ScrapeService",function(e,t,a,n){var o=this;return o.getPermissions=function(e){var a=t.defer();return chrome.permissions.request({permissions:e},function(e){e?a.resolve(!0):(alert("DataMiner needs your permission to download"),a.reject(!1))}),a.promise},o.startJob=function(t){var s;o.files=[];var i=!1,r=1,l=async.cargo(function(e,a){var r=e[0].data;"download.image"==t.type?i||n.downloadImage(r,t,function(e){o.files.push(e),$scope.$digest()}):"download.page"==t.type?i||n.downloadPage(r,t,function(e){o.files.push(e),setTimeout(function(){a()},1e3*t.wait_time+Math.random()*t.wait_time*500)}):"scrape.page"==t.type?i||n.scrapePage(s,r,t,function(e){o.files.push(e)},function(e){void 0!==e&&void 0!==e.error&&(i=!0,n.stop(),c.getButton("btn-stop").click()),a()}):"utility.replace"==t.type&&(i||n.replace(r,t,function(e){var a={type:"data",name:file.name,created_at:(new Date).toLocaleString(),data:{}};a.data=e,a.col_count=Object.keys(e).length,datasets.db.collection.add(a),datasets.db.collection.where("name").equals(t.collection).toArray(function(t){o.files.push(e),$scope.$digest()})}))},1);l.drain=function(){console.log("All jobs finished"),s&&s.id&&chrome.tabs.remove(s.id),g("Finished processing all pages",!0)};var c=BootstrapDialog.show({size:BootstrapDialog.SIZE_NORMAL,message:"<span id='dialogMessage'><span class='dialog-main-text'>Scraping job started</span><br><br><i class='fa fa-eye'></i> You can view the accumulating data in your <a href='/admin/index.html#/collections' target='_blank'> Collection <i class='fa fa-external-link'></i></a> while the job is running.<br><br><img src='../assets/layouts/layout/img/job-tip.png'><br></span>",title:"Data Miner",buttons:[{id:"btn-stop",label:"Stop",icon:"fa fa-stop",action:function(e){l.kill();var t=e.getButtons();"Close"==t[0].label?e.close():(i=!0,n.stop(),t[0].label="Close",t[0].icon="",e.updateButtons())}}]});c.getModal().css({top:"10%","margin-top":"0"});var g=function(e,t){var a=(new Date).toLocaleString();if(c.getModalBody().find("#dialogMessage").html(e+"<br><br><br>"+a),t){var n=c.getButtons();n[0].label="Close",n[0].icon="",c.updateButtons()}},u=chrome.extension.getBackgroundPage().dmBackground.serverData;a.getCollectionData(t.collection).then(function(e){var a=t.source_range.split("-");""===t.source_range?(t.range_start=0,t.range_end=e.length):"-"===t.source_range.slice(-1)?(t.range_start=Math.max(0,parseInt(a[0])-1),t.range_end=e.length):"-"===t.source_range[0]?(t.range_start=0,t.range_end=Math.min(e.length,parseInt(a[1])-1)):2===a.length?(t.range_start=Math.max(0,parseInt(a[0])-1),t.range_end=Math.min(e.length,parseInt(a[1]))):(t.range_start=0,t.range_end=e.length),u.capability.multi.enabled||(t.range_end=Math.min(t.range_end,t.range_start+3));for(var n=[],o=t.range_start;o<t.range_end;o++){var c=e[o].data[Object.keys(e[o].data)[t.position-1]];c&&0==c.toLowerCase().indexOf("http")&&n.push(e[o])}if(n.length>0&&"scrape.page"==t.type){var d=0;0!==t.start_delay&&(d=60*t.start_delay*1e3,g("Waiting for "+t.start_delay+" minute(s) before starting this job. <br><br> You must leave your browser running but you can minimize it and lock your computer screen through your operating system.")),setTimeout(function(){i||chrome.tabs.create({url:"admin/starting.html"},function(e){s=e,l.push(n,function(e){console.log("finished processing item"),g("<span id='dialogMessage'><span class='dialog-main-text'>Processed input rows: "+r+"</span><br><br><i class='fa fa-eye'></i> You can view the accumulating data in your <a href='/admin/index.html#/collections' target='_blank'> Collection <i class='fa fa-lg fa-external-link'></i></a>while the job is running.<br><br><img src='../assets/layouts/layout/img/job-tip.png'></span>"),r+=1;var t=chrome.extension.getBackgroundPage().dmBackground.serverData;"segment"in t&&(g(t.segment.restrictedCols),i=!0)})})},d)}else l.push(n,function(e){console.log("finished processing item"),g("Processed Page: "+r),r+=1})},function(t){e.alert(t)})},{getPermissions:o.getPermissions,startJob:o.startJob}}]);
//# sourceMappingURL=../../../../map/common/js/services/RunJobService.js.map