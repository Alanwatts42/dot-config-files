"use strict";angular.module("MetronicApp").controller("CollectionListController",["$scope","$location","DataService","CurrentCollectionService","$q","$window",function(e,t,n,o,a,l){var i=this;i.collections=[],i.collectionNames=[],i.message="",i.gridHeight=l.innerHeight-250;var r=function(){var e=a.defer();return DM.testMode?e.resolve():chrome.permissions.request({permissions:["downloads"]},function(t){t?e.resolve():(alert("DataMiner needs your permission to download the file"),e.reject("Something went wrong!!!"))}),e.promise};i.getShortNames=function(){i.collectionNames=[],angular.forEach(i.collections,function(e){var t=e;e.startsWith("www.")&&(e=e.substring(4)),this.push({fullName:t,shortName:function(e,t,n){if(e.length<=t)return e;var o=t-(n=n||"...").length,a=Math.ceil(o/2),l=Math.floor(o/2);return e.substr(0,a)+n+e.substr(e.length-l)}(e,35)})},i.collectionNames)},i.downloadCSV=function(e,t){i.message="Preparing file .... please wait",r().then(function(){n.getCollectionData(e).then(function(t){var n,o,a=[];if($.each(t,function(e,t){a.push(t.data)}),t=null,a.length>1e4)for(var l=0;l<a.length;l+=1e4){var r=Papa.unparse(a.slice(l,1e4+l));n=URL.createObjectURL(new Blob([r],{type:"text/csv;charset=utf-8;"})),o=e.replace(/[^\w]/g,"_")+"_"+l.toString()+".csv",console.log("csv length "+n.length),console.log("File "+o),alert("Your collection is very large. It will be downloaded in 50000 increments."),chrome.downloads.download({url:n,filename:o,saveAs:!1},function(){}),i.message=""}else{var c=Papa.unparse(a);n=URL.createObjectURL(new Blob([c],{type:"text/csv;charset=utf-8;"})),o=e.replace(/[^\w]/g,"_")+".csv",chrome.downloads.download({url:n,filename:o,saveAs:!0},function(){}),i.message=""}},function(e){i.message="Error",l.alert(e)})})},i.downloadXLSX=function(e,t){i.message="Preparing file .... please wait",r().then(function(){n.getCollectionData(e).then(function(t){var n='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><tbody><table><thead><tr>';angular.forEach(t[0].data,function(e,t){n+="<th>"+t+"</th>"}),n+="</tr></thead><tbody>",angular.forEach(t,function(e){n+="<tr>",angular.forEach(e.data,function(e,t){n+="<td>"+e+"</td>"}),n+="</tr>"}),n+="</tbody></table></body></html>";var o=URL.createObjectURL(new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8"})),a=e.replace(/[^\w]/g,"_")+".xls";chrome.downloads.download({url:o,filename:a,saveAs:!0},function(){}),i.message=""},function(e){i.message="Error",l.alert(e)})})},i.ShowProperties=function(e){console.log("Show properties")},i.refreshList=function(){n.getCollectionNames().then(function(e){i.collections=e,i.getShortNames()},function(e){l.alert(e)})},i.getNames=function(){n.getCollectionNames().then(function(e){i.collections=e},function(e){l.alert(e)})},i.select=function(e){n.getCollectionData(e).then(function(t){o.name=e,o.data=t},function(e){l.alert(e)})},i.deleteAll=function(){n.deleteCollectionAll().then(function(){i.refreshList()},function(e){l.alert(e)})},i.delete=function(e){n.deleteCollection(e).then(function(){o.name="",o.data=[],i.refreshList()},function(e){l.alert(e)})};var c=function(e,o,a){Papa.parse(e,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,complete:function(o){var r=[];angular.forEach(o.data,function(t,n){for(var a={type:"data",name:e.name,created_at:(new Date).toLocaleString(),data:{}},l=t[o.meta.fields[0]],i=1;i<o.meta.fields.length;i++)l=l.split(o.meta.fields[i]).join(t[o.meta.fields[i]]);t[o.meta.fields[0]]=l,a.data=t,a.col_count=Object.keys(t).length,this.push(a)},r),n.addCollection(r).then(function(){i.refreshList(),i.message="Your data was loaded",t.path("/collections"),a()},function(e){l.alert(e)})}})};$("#csv-file").change(function(e){i.message="Loading ... please wait.";var t=e.target.files[0];c(t,0,function(){$("#csv-file").val(null)})}),$("#collection-from-template").change(function(e){i.message="Loading ... please wait.";var t=e.target.files[0];c(t,0,function(){$("#collection-from-template").val(null)})}),angular.element(l).bind("resize",function(){i.gridHeight=l.innerHeight-250,e.$digest()}),i.refreshList()}]);
//# sourceMappingURL=../../../../map/admin/js/controllers/CollectionController.js.map