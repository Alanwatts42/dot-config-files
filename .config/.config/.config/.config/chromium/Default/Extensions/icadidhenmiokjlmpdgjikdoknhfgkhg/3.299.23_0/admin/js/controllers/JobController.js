"use strict";angular.module("MetronicApp").controller("JobController",["$scope","$location","RemoteDataService","RecipeService","CurrentCollectionService","RunJobService","DataService","$q","$window","$filter",function(e,t,o,r,i,n,a,c,s,l){var u=this;u.jobs=[],u.jobSataus=!1;var d=function(){u.recipes=[],u.message="",u.loginError="",u.showAdvance=!1,u.upgradeMessage="";var e=chrome.extension.getBackgroundPage(),t="";void 0!==e.DMState.lastUrlInfo.protocol&&(t=e.DMState.lastUrlInfo.protocol+"//"+e.DMState.lastUrlInfo.domain),u.selectedJob=null,u.form1={name:"",recipe_object:null,recipe:"",url:t,collection:"",position:1,dest_collection:"output",source_range:"",wait_time:15,referrer_set:"",start_delay:0,follow_pagination:!1,max_pagination:10},""!==u.form1.url&&u.lookupRecipe(),o.testLogin().then(function(e){void 0!==e&&void 0!==e.user_id&&($("#save-button")[0].disabled=!1),f(e)},function(e){u.loginError=e}),u.refreshList()},f=function(e){return void 0!==e.capability&&e.capability.multi.enabled?e.segment?(u.upgradeMessage=e.segment.restrictedCols,!1):void 0:(u.upgradeMessage=e.capability.multi.message,!1)};u.toggleAdvance=function(){u.showAdvance=!u.showAdvance},u.lookupRecipe=function(e){var t,o=c.defer();return u.message="",void 0===e&&""===u.form1.url&&(u.message="Please specify the domain name and then click on Get Recipes",o.reject("Something went wrong!!!")),void 0===e?(t=DM.utility.getDomain(u.form1.url),u.form1.recipe_object&&(e=u.form1.recipe_object.id)):t="none",r.getRecipesPromise({urlInfo:t,recipe_id:e,source:"jobs"}).then(function(t){u.recipes=[];var r=t.results;Array.isArray(r.userRecipes)&&angular.forEach(r.userRecipes,function(e,t){e.UIType="My Recipes",this.push(e)},u.recipes),Array.isArray(r.communityRecipes)&&angular.forEach(r.communityRecipes,function(e,t){e.UIType="Public Recipes",this.push(e)},u.recipes);var i=l("filter")(u.recipes,function(t){return t.id===e});u.form1.recipe_object=i[0],o.resolve()},function(e){alert("Failed: "+e),o.reject("Something went wrong!!!")}),o.promise},u.clearForm=function(){d()},u.refreshList=function(){o.getJobs().then(function(e){u.jobs=e},function(e){u.loginError=e})},u.deleteJob=function(e){o.deleteJob(e).then(function(t){u.jobs=l("filter")(u.jobs,function(t){return t.id!==e})},function(e){s.alert(e)})},u.startJob=function(e){var t;u.jobStatus=!0,n.getPermissions(["downloads"]).then(function(){if(!(t=l("filter")(u.jobs,function(t){return t.id===e})[0]).data.recipe)throw new Error('Error: Please specify a recipe to use. To get an updated list of recipes specify the URL andclick on "Get Recipes" button.');u.lookupRecipe(t.data.recipe)}).then(function(){n.startJob(t.data)}).catch(function(e){alert(e.message)})},u.editJob=function(e){u.selectedJob=l("filter")(u.jobs,function(t){return t.id===e})[0],u.form1=u.selectedJob.data,u.form1.url=u.selectedJob.data.url,u.lookupRecipe()},u.saveJob=function(){var e=!1;null===u.selectedJob?(u.selectedJob={schema:"v1",data:u.form1,name:u.form1.name},u.selectedJob.data.type="scrape.page"):(u.selectedJob.data=u.form1,u.selectedJob.name=u.form1.name,e=!0),u.selectedJob.data.recipe=parseInt(u.form1.recipe_object.id),u.selectedJob.data.wait_time=parseInt(u.form1.wait_time),u.selectedJob.data.source_range=u.form1.source_range.trim(),u.selectedJob.data.start_delay=parseInt(u.form1.start_delay),"string"==typeof u.form1.max_pagination&&(""!==u.form1.max_pagination.trim()?u.selectedJob.data.max_pagination=parseInt(u.form1.max_pagination):u.selectedJob.data.max_pagination=1e3),o.saveJobs(u.selectedJob).then(function(t){!0===e&&(u.jobs=l("filter")(u.jobs,function(e){return e.id!==t.id})),u.jobs.push(t),d()},function(e){s.alert(e)})},d()}]);
//# sourceMappingURL=../../../../map/admin/js/controllers/JobController.js.map