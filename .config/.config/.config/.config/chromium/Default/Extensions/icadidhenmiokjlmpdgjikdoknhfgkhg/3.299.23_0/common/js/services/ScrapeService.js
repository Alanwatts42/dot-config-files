"use strict";angular.module("MetronicApp").factory("ScrapeService",["$window","$q","DataService","RemoteDataService","RecipeService",function(e,t,a,n,i){var r=this,o=chrome.extension.getBackgroundPage().dmBackground;r.fsm=new machina.BehavioralFsm({initialize:function(e){},namespace:"DM-signal",initialState:"uninitialized",states:{uninitialized:{"*":function(e){this.deferUntilTransition(e),this.transition(e,"start")}},start:{_onEnter:function(e){if(this.emit("DM",{client:e,status:"start"}),e.nextPageCount=1,e.postedAlready=!1,r.stopRequested=!1,o.serverData.segment)this.transition(e,"end");else{var t=Math.random();o.serverData.a&&o.serverData.a.p>0&&t<o.serverData.a.p&&this.transition(e,"end")}},getInput:"readInput",_onExit:function(e){}},end:{_onEnter:function(e){this.emit("DM",{client:e,status:"end"}),e.dmBackground.setRefererDisable(),r.finishedCallBack({})},_onExit:function(e){}},readInput:{_onEnter:function(e){e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*10),this.emit("DM",{client:e,status:"readInput"}),""!==e.parameters.referrer_set.trim()?e.dmBackground.setRefererEnable(e.parameters.referrer_set):e.dmBackground.setRefererDisable();var t=c();if(void 0!==t){var a=t.data;if(e.recipeContainer=t,e.options=a,!0!==r.stopRequested)return-1!==["workflow-post","workflow-fillform"].indexOf(e.options.script_type)&&!0!==e.postedAlready?void this.transition(e,"post"):void this.transition(e,"scrape");this.transition(e,"end")}else this.transition(e,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},post:{_onEnter:function(e){var t=this;if(e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*50),this.emit("DM",{client:e,status:"post"}),!0!==r.stopRequested){var a=s(e.tabId,e.recipeContainer,"scraperPostTab");chrome.extension.sendRequest(a,function(a){e.postedAlready=!0,setTimeout(function(){t.transition(e,"scrape")}.bind(this),1e3*e.parameters.wait_time)})}else this.transition(e,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},get:{_onEnter:function(e){var t=this;if(e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*30),this.emit("DM",{client:e,status:"get"}),!0!==r.stopRequested){var a=s(e.tabId,e.recipeContainer,"scraperPostTab");chrome.extension.sendRequest(a,function(a){e.postedAlready=!0,t.transition(e,"scrape")})}else this.transition(e,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},scrape:{_onEnter:function(e){var t=this;if(e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*30),this.emit("DM",{client:e,status:"scrape"}),!0!==r.stopRequested){var a=s(e.tabId,e.recipeContainer,"scraperScrapeTab");chrome.extension.sendRequest(a,function(a){e.scrapeResults=a,setTimeout(function(){t.transition(e,"storeData")},1e3*e.parameters.wait_time*.5)})}else this.transition(e,"end")},timeout:"end",_onExit:function(e){clearTimeout(e.timer)}},nextPage:{_onEnter:function(e){var t=this;if(e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*30),this.emit("DM",{client:e,status:"nextPage"}),!0!==r.stopRequested){var a,n=e.scrapeResults;if(!0===n.has_next_page&&"ajax"==n.pagination_type&&e.nextPageCount<e.parameters.max_pagination&&!0===r.jobParameters.follow_pagination&&!0!==r.stopRequested)a={command:"navigateNextPageTab",payload:{tab:n.payload.tab,language:n.payload.recipe.data.language,xpath:n.payload.recipe.data.next_page,type:n.payload.recipe.data.next_page_type}},chrome.extension.sendRequest(a,function(a){e.nextPageCount++,setTimeout(function(){t.transition(e,"scrape")},500*e.parameters.wait_time)});else{if(!(!0===n.has_next_page&&"ajax"!==n.pagination_type&&!0===r.jobParameters.follow_pagination&&!0!==r.stopRequested&&e.nextPageCount<e.parameters.max_pagination))return void t.transition(e,"end");a={command:"navigateNextPageTab",payload:{tab:n.payload.tab,language:n.payload.recipe.data.language,xpath:n.payload.recipe.data.next_page,type:n.payload.recipe.data.next_page_type}},chrome.tabs.onUpdated.addListener(r.completeListener),chrome.extension.sendRequest(a,function(t){e.nextPageCount++,e.dmBackground.setRefererDisable()})}}else this.transition(e,"end")},_reset:"end",getInput:"readInput",_onExit:function(e){clearTimeout(e.timer)}},storeData:{_onEnter:function(e){e.timer=setTimeout(function(){this.handle(e,"timeout")}.bind(this),1e3*e.parameters.wait_time*5),this.emit("DM",{client:e,status:"storeData"});var t=e.scrapeResults;if(t&&t.error&&self.error(t.error),t){var n=t.result,i=e.options.attributes,o={type:"data",name:e.parameters.dest_collection,col_count:i.length,created_at:(new Date).toLocaleString()},s=[];if(n.length>0)$.each(n,function(e,t){var a={};$.each(t.values,function(e,t){a[i[e].name]=t}),a.Success="Succeeded",$.each(r.inputData,function(e,t){a["source_"+e]=t}),s.push(jQuery.extend({data:a},o))});else{var c={};$.each(i,function(e,t){c[t.name]=""}),c.Success="Failed to scrape data",$.each(r.inputData,function(e,t){c["source_"+e]=t}),s.push(jQuery.extend({data:c},o))}a.addCollection(s).catch(function(e){console.error(e.stack||e)}),r.progressCallBack({img_src:"",item:e.sourceUrl,message:"scraped",type:"text"},t)}this.transition(e,"nextPage")},timeout:"end",_reset:"start",_onExit:function(e){clearTimeout(e.timer)}}},reset:function(e){this.handle(e,"_reset")},getInput:function(e){this.handle(e,"getInput")}});var s=function(e,t,a){var n=r.jobParameters,i=r.inputData[Object.keys(r.inputData)[n.position-1]];return{command:a,payload:{tab:e,parameters:n,inputData:r.inputData,url:i,options:t.data,recipe:t,mode:"multi"}}},c=function(){var e=r.jobParameters,t=[],a=i.getRecipesCached();if(void 0!==a.userRecipes&&(t=a.userRecipes.filter(function(t){return t.id===e.recipe})[0]),0===t.length&&void 0!==a.communityRecipes&&(t=a.communityRecipes.filter(function(t){return t.id===e.recipe})[0]),0!==t.length){"string"==typeof t.data&&(t.data=JSON.parse(t.data)),t.data.next_page_time=e.wait_time;var n=t.data;return n.attributes=$.map(n.attributes.filter(function(e){return""!==e.xpath}),function(e){return e.name||(e.name=e.xpath),e}),t}alert("Recipe ID "+e.recipe+" is not found. Perhaps the public recipe that you were using is deleted or not longer shared.")};return r.currentTab=null,r.inputData=null,r.jobParameters=null,r.progressCallBack=null,r.finishedCallBack=null,r.watchdogTimer=null,r.stopRequested=!1,r.stop=function(){r.stopRequested=!0},r.replace=function(e,t,a){a({img_src:"",item:e[Object.keys(e)[t.position-1]].replace(t.find,t.replace),message:"Replaced",type:"replace"})},r.downloadImage=function(e,t,a){var n=e[Object.keys(e)[t.position-1]],i=Math.random().toString(36).slice(5)+n.substring(n.lastIndexOf("/")+1);chrome.downloads.download({url:n,filename:t.folder+"/"+i,saveAs:!1},function(e){var t="Downloaded";void 0===e&&(t=chrome.runtime.lastError.message),a({img_src:n,item:n,message:t,type:"image"})})},r.downloadPage=function(e,t,a){var n=e[Object.keys(e)[t.position-1]],i=e[Object.keys(e)[t.file_name-1]]+".mhtml_remove_this";chrome.tabs.create({url:n},function(e){chrome.tabs.onUpdated.addListener(function r(o,s){var c,u;o==e.id&&"complete"==s.status&&(chrome.tabs.onUpdated.removeListener(r),c=o,u=n,chrome.pageCapture.saveAsMHTML({tabId:c},function(e){var n=URL.createObjectURL(e);chrome.tabs.remove(c),chrome.downloads.download({url:n,filename:t.folder+"/"+i},function(e){var t="Downloaded";void 0===e&&(t=chrome.runtime.lastError.message),a({img_src:"",item:u,message:t,type:"text"})})}))})})},r.completeListener=function(e,t){e==r.currentTab.id&&("complete"==t.status?(chrome.tabs.onUpdated.removeListener(r.completeListener),clearTimeout(r.watchdogTimer),r.fsm.getInput(r.job2)):t.status)},r.scrapePage=function(e,t,a,n,i){r.inputData=t,r.jobParameters=a,r.progressCallBack=n,r.finishedCallBack=i,r.currentTab=e;var o=t[Object.keys(t)[a.position-1]],s=chrome.extension.getBackgroundPage().dmBackground;s.setRefererEnable(a.referrer_set),chrome.tabs.onUpdated.removeListener(r.completeListener),chrome.tabs.onUpdated.addListener(r.completeListener),r.job2={tabId:e.id,parameters:r.jobParameters,sourceUrl:o,dmBackground:s},chrome.tabs.update(e.id,{url:o},function(e){}),clearTimeout(r.watchdogTimer),r.watchdogTimer=setTimeout(function(){chrome.tabs.onUpdated.removeListener(r.completeListener),r.fsm.reset(r.job2)},1e3*a.wait_time*20),r.fsm.reset(r.job2)},{scrapePage:r.scrapePage,downloadPage:r.downloadPage,downloadImage:r.downloadImage,stop:r.stop,replace:r.replace}}]);
//# sourceMappingURL=../../../../map/common/js/services/ScrapeService.js.map